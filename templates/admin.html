<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM - KitPc</title>
    <link rel="icon" href="{{ url_for('static', filename='Imagens/favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/admin.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
    
</head>
<body class="bg-dark text-white">

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-11">
                
                <div class="text-center mb-4">
                    <h1 class="display-5" style="font-family: 'Orbitron', sans-serif; color: #00f2ff; text-shadow: 0 0 10px #00f2ff;">PAINEL ADM</h1>
                    <p class="text-info">GERENCIAMENTO DE CONTE√öDO CLOUD</p>
                </div>

                <div class="card shadow" style="background: rgba(15, 15, 15, 0.95); border: 1px solid #00f2ff;">
                    <div class="card-header text-center py-3" style="background: #00f2ff; color: #000;">
                        <h3 class="mb-0 fw-bold">
                            {% if edit_post %} MODO EDI√á√ÉO: {{ edit_post.titulo }} {% else %} CONSOLE DE PUBLICA√á√ÉO {% endif %}
                        </h3>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="section-post mb-5">
                            <h4 class="text-info mb-4">{% if edit_post %} <i class="fas fa-edit"></i> ATUALIZAR ARTIGO {% else %} <i class="fas fa-pen-nib"></i> ESCREVER NOVO ARTIGO {% endif %}</h4>
                            
                            <form id="postForm" action="{{ url_for('salvar_post', id=edit_post.id if edit_post else None) }}" method="POST" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label text-info">T√≠tulo</label>
                                        <input type="text" name="titulo" class="form-control bg-dark text-white border-secondary" value="{{ edit_post.titulo if edit_post else '' }}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-info">Resumo</label>
                                        <input type="text" name="subtitulo" class="form-control bg-dark text-white border-secondary" value="{{ edit_post.subtitulo if edit_post else '' }}">
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-12 mb-3">
                                        <label class="form-label text-info">Capa da Mat√©ria</label>
                                        <div class="drop-zone" id="drop-zone">
                                            <span id="file-name" class="text-secondary">
                                                {% if edit_post %} <span class="text-info">Imagem atual carregada.</span> Clique para trocar. {% else %} Selecione a imagem principal {% endif %}
                                            </span>
                                            <input type="file" name="arquivo_imagem" id="file-upload" class="d-none" accept="image/*">
                                            <img id="preview-img" src="{{ edit_post.imagem_url if edit_post else '#' }}" alt="Preview" class="{{ 'mt-3' if edit_post else 'd-none mt-3' }}" style="max-height: 120px; border-radius: 5px;">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label text-info">Corpo do Texto</label>
                                    <div id="editor-container" style="height: 400px; color: white;"></div>
                                    <input type="hidden" name="conteudo" id="conteudo_hidden">
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-info btn-lg fw-bold shadow-sm">
                                        {% if edit_post %} SALVAR ALTERA√á√ïES {% else %} PUBLICAR NO KITPC {% endif %}
                                    </button>
                                    {% if edit_post %}
                                        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary mt-2">CANCELAR EDI√á√ÉO</a>
                                    {% endif %}
                                </div>
                            </form>
                        </div>

                        <hr class="cyber-hr my-5">

                        <div class="section-posts mb-5">
                            <h4 class="text-info mb-3">üì∞ GERENCIAR POSTAGENS</h4>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover align-middle border-secondary">
                                    <thead class="table-warning text-dark">
                                        <tr>
                                            <th>T√≠tulo</th>
                                            <th>Status</th>
                                            <th class="text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in posts | default([]) %}
                                        <tr style="opacity: {{ '0.5' if p.arquivado else '1' }};">
                                            <td>{{ p.titulo }}</td>
                                            <td>
                                                <span class="badge {{ 'bg-secondary' if p.arquivado else 'bg-success' }}">
                                                    {{ 'ARQUIVADO' if p.arquivado else 'P√öBLICO' }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="d-flex justify-content-center gap-2">
                                                    <a href="{{ url_for('editar_post', id=p.id) }}" class="btn btn-warning btn-sm">EDITAR</a>
                                                    <form action="{{ url_for('arquivar_post', id=p.id) }}" method="POST">
                                                        <button type="submit" class="btn btn-outline-info btn-sm">
                                                            {{ 'DESARQUIVAR' if p.arquivado else 'ARQUIVAR' }}
                                                        </button>
                                                    </form>
                                                    <form action="{{ url_for('deletar_post', id=p.id) }}" method="POST" onsubmit="return confirm('Excluir permanentemente?')">
                                                        <button type="submit" class="btn btn-danger btn-sm">X</button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <hr class="cyber-hr my-5">

                        <div class="section-users">
                            <h4 class="text-info mb-3">üë• USU√ÅRIOS NO SISTEMA</h4>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover border-secondary">
                                    <thead class="table-info text-dark">
                                        <tr><th>Nome</th><th>E-mail</th><th>Status</th><th class="text-center">A√ß√µes</th></tr>
                                    </thead>
                                    <tbody>
                                        {% for user in usuarios | default([]) %}
                                        <tr>
                                            <td>{{ user.nome }}</td>
                                            <td>{{ user.email }}</td>
                                            <td><span class="badge {{ 'bg-success' if user.confirmado else 'bg-warning text-dark' }}">{{ 'ATIVO' if user.confirmado else 'PENDENTE' }}</span></td>
                                            <td class="text-center">
                                                <div class="d-flex justify-content-center gap-2">
                                                    {% if not user.confirmado %}
                                                    <form action="{{ url_for('confirmar_usuario_admin', id=user.id) }}" method="POST"><button type="submit" class="btn btn-success btn-sm">ATIVAR</button></form>
                                                    {% endif %}
                                                    <form action="{{ url_for('deletar_usuario_admin', id=user.id) }}" method="POST"><button type="submit" class="btn btn-outline-danger btn-sm">APAGAR</button></form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-grid gap-2 mt-5 p-5">
        <a href="/" class="btn btn-outline-secondary">SAIR E VOLTAR PARA A HOME</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

    <script>
        // Configura√ß√£o do Quill 2.0 com suporte a Tabelas
        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                table: true, // Ativa o m√≥dulo de tabela
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    ['link', 'image', 'video'],
                    ['table'], // Bot√£o de tabela adicionado aqui
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            },
            placeholder: 'Desenvolva sua mat√©ria aqui...'
        });

        // CARREGA CONTE√öDO NA EDI√á√ÉO COM SEGURAN√áA
        {% if edit_post and edit_post.conteudo %}
            quill.root.innerHTML = {{ edit_post.conteudo | tojson | safe }};
        {% endif %}

        // UPLOAD DE IMAGEM NO CORPO
        var toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', function() {
            var input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            input.onchange = function() {
                var file = input.files[0];
                var formData = new FormData();
                formData.append('image', file);
                fetch('/admin/upload-imagem-corpo', { method: 'POST', body: formData })
                .then(r => r.json()).then(res => {
                    if (res.url) {
                        var range = quill.getSelection();
                        quill.insertEmbed(range.index, 'image', res.url);
                    }
                });
            };
        });

        // Envia o HTML do Quill para o input hidden antes de postar
        document.getElementById('postForm').onsubmit = function() {
            document.getElementById('conteudo_hidden').value = quill.root.innerHTML;
        };

        // PREVIEW DA CAPA
        const fileInput = document.getElementById('file-upload');
        const previewImg = document.getElementById('preview-img');
        const fileName = document.getElementById('file-name');
        document.getElementById('drop-zone').onclick = () => fileInput.click();
        fileInput.onchange = function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                fileName.innerText = "Novo arquivo: " + this.files[0].name;
                reader.onload = e => { 
                    previewImg.src = e.target.result; 
                    previewImg.classList.remove('d-none'); 
                }
                reader.readAsDataURL(this.files[0]);
            }
        };
    </script>
</body>
</html>